#!/bin/bash
# Pre-commit hook to validate code before commit
# This hook runs automatically before each commit

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check for merge conflict markers
echo -n "Checking for merge conflict markers... "
if git diff --cached | grep -E '^(<<<<<<<|=======|>>>>>>>)'; then
    echo -e "${RED}FAILED${NC}"
    echo "Error: Merge conflict markers detected in staged files"
    echo "Please resolve conflicts before committing"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# Check for debugging code
echo -n "Checking for debugging code... "
DEBUGGING_PATTERNS='(import pdb|pdb\.set_trace|breakpoint\(\)|import ipdb|ipdb\.set_trace)'
if git diff --cached | grep -E "$DEBUGGING_PATTERNS"; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "Warning: Debugging code detected (pdb/breakpoint/ipdb)"
    echo ""
    git diff --cached | grep -E "$DEBUGGING_PATTERNS" --color=always
    echo ""
    read -p "Do you want to continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Commit aborted. Please remove debugging code."
        exit 1
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for print statements (warn but don't block)
echo -n "Checking for print statements... "
PRINT_PATTERN='^\+.*print\('
PRINT_COUNT=$(git diff --cached | grep -c -E "$PRINT_PATTERN" || true)
if [ "$PRINT_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "Found $PRINT_COUNT new print statement(s). Consider using logging instead."
    echo "Logging example: logger.info('message') or logger.debug('message')"
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for TODOs without issue numbers
echo -n "Checking for TODOs... "
TODO_PATTERN='^\+.*# TODO(?!.*#[0-9]+)'
TODO_COUNT=$(git diff --cached | grep -c -E "$TODO_PATTERN" || true)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "Found $TODO_COUNT TODO comment(s) without issue reference."
    echo "Consider linking to a GitHub issue: # TODO: Fix this #123"
else
    echo -e "${GREEN}OK${NC}"
fi

# Get list of staged Python files
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$PYTHON_FILES" ]; then
    # Run flake8 on staged Python files
    echo -n "Running flake8 on Python files... "
    if flake8 $PYTHON_FILES 2>&1 | tee /tmp/flake8_output.txt; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo ""
        echo "flake8 found style issues:"
        cat /tmp/flake8_output.txt
        echo ""
        echo "Please fix the above issues before committing."
        echo "Tip: Some issues can be auto-fixed with: black $PYTHON_FILES"
        rm -f /tmp/flake8_output.txt
        exit 1
    fi
    rm -f /tmp/flake8_output.txt

    # Check for proper imports in Python files
    echo -n "Checking Python import order... "
    IMPORT_ISSUES=0
    for file in $PYTHON_FILES; do
        # Check if file has imports mixing standard library and third-party
        # This is a simple heuristic check
        if git diff --cached $file | grep -E '^\+import|^\+from' > /dev/null; then
            # Just a reminder, not blocking
            : # No-op, we'll just continue
        fi
    done
    echo -e "${GREEN}OK${NC}"

    # Check for missing type hints in function definitions (warning only)
    echo -n "Checking for type hints... "
    MISSING_HINTS=$(git diff --cached | grep -E '^\+\s*def [a-z_]+\([^)]*\)(?!.*->)' | wc -l || true)
    if [ "$MISSING_HINTS" -gt 0 ]; then
        echo -e "${YELLOW}NOTICE${NC}"
        echo "Found $MISSING_HINTS new function(s) without return type hints."
        echo "Consider adding type hints: def func(arg: Type) -> ReturnType:"
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo "No Python files to check."
fi

# Check for large files
echo -n "Checking for large files... "
LARGE_FILES=$(git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
        if [ "$size" -gt 1048576 ]; then  # 1MB
            echo "$file ($size bytes)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo "Large files detected (>1MB):"
    echo "$LARGE_FILES"
    echo ""
    read -p "Are you sure you want to commit these large files? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Commit aborted. Consider using Git LFS for large files."
        exit 1
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# Check for secrets/credentials (common patterns)
echo -n "Checking for potential secrets... "
SECRET_PATTERNS='(password|secret|api_key|token|aws_access|private_key)\s*=\s*["\047][^"\047]'
if git diff --cached | grep -iE "$SECRET_PATTERNS"; then
    echo -e "${RED}FAILED${NC}"
    echo "Error: Potential secrets or credentials detected!"
    echo "Please remove sensitive data before committing."
    echo ""
    git diff --cached | grep -iE "$SECRET_PATTERNS" --color=always
    exit 1
fi
echo -e "${GREEN}OK${NC}"

echo ""
echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
echo ""

exit 0
