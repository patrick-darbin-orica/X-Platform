<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Sensor Plot with Legend Below</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    svg { border: 1px solid #ccc; }
    .legend { font-size: 14px; }
  </style>
</head>
<body>
  <h2>Real-Time Sensor Data</h2>
  <svg width="1200" height="650"></svg>

  <script>
    const svg = d3.select("svg");
    const width = +svg.attr("width");
    const height = +svg.attr("height")
    const host = "192.168.2.188"

    const margin = { top: 20, right: 200, bottom: 80, left: 50 };
    const plotWidth = width - margin.left - margin.right;
    const plotHeight = height - margin.top - margin.bottom;

    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const maxPoints = 200;
    const keys = ["depth", "tension", "water", "td"];
    const colors = {
      depth: "steelblue",
      tension: "orange",
      water: "green",
      td: "purple"
    };

    const data = [];

    const yScales = {
      depth: d3.scaleLinear().domain([0, 100]).range([plotHeight, 0]),
      tension: d3.scaleLinear().domain([-10, 90]).range([plotHeight, 0]),
      water: d3.scaleLinear().domain([0, 1]).range([plotHeight, 0]),
      td: d3.scaleLinear().domain([0, 1]).range([plotHeight, 0])
    };

    const xScale = d3.scaleLinear().range([0, plotWidth]);
    const xAxis = g.append("g").attr("transform", `translate(0,${plotHeight})`);

    const lines = {};
    const paths = {};

    keys.forEach(key => {
      lines[key] = d3.line()
        .x(d => xScale(d.timestamp))
        .y(d => yScales[key](d[key]));

      paths[key] = g.append("path")
        .attr("fill", "none")
        .attr("stroke", colors[key])
        .attr("stroke-width", 2);
    });

    // Y axes
    let yOffset = 0;
    keys.forEach(key => {
      const axisGroup = g.append("g")
        .attr("transform", `translate(${plotWidth + yOffset},0)`)
        .call(d3.axisRight(yScales[key]).ticks(5));

      axisGroup.selectAll("path, line")
        .attr("stroke", colors[key]);

      axisGroup.append("text")
        .attr("transform", `rotate(-90)`)
        .attr("y", 35)
        .attr("x", -plotHeight / 2)
        .attr("dy", "-0.1em")
        .attr("dx", "-0.5em")
        .attr("fill", colors[key])
        .attr("text-anchor", "middle")
        .text(key);

      yOffset += 50;
    });

    // Legend below the x-axis
    const legend = svg.append("g")
      .attr("class", "legend")
      .attr("transform", `translate(${margin.left},${height - 40})`);

    keys.forEach((key, i) => {
      const legendItem = legend.append("g")
        .attr("transform", `translate(${i * 150}, 0)`);

      legendItem.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 20)
        .attr("height", 10)
        .attr("fill", colors[key]);

      legendItem.append("text")
        .attr("x", 25)
        .attr("y", 10)
        .text(key);
    });

    // WebSocket connection
    const socket = new WebSocket("ws://" + host + ":6789");

    socket.onopen = () => console.log("WebSocket connected.");
    socket.onerror = err => console.error("WebSocket error:", err);
    socket.onclose = () => console.warn("WebSocket closed.");

    socket.onmessage = function(event) {
      try {
        const parsed = JSON.parse(event.data);
        const isValid = keys.every(key => typeof parsed[key] === 'number' && !isNaN(parsed[key]));
        if (!isValid) {
          console.warn("Invalid data received:", parsed);
          return;
        }

        data.push(parsed);
        if (data.length > maxPoints) data.shift();

        const timestamps = data.map(d => d.timestamp);
        xScale.domain(d3.extent(timestamps));
        xAxis.call(d3.axisBottom(xScale).ticks(6));

        keys.forEach(key => {
          paths[key].datum(data).attr("d", lines[key]);
        });

      } catch (err) {
        console.error("Error parsing message:", err);
      }
    };
  </script>
</body>
</html>